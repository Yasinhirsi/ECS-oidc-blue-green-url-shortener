name: Deploy to ECS

on:
  workflow_dispatch:
    inputs:
      image-uri:
        description: "Image URI from ECR (e.g., 123456789.dkr.ecr.eu-west-2.amazonaws.com/url-shortener:abc123)"
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: eu-west-2

      - name: Create new task definition with updated image
        id: create-task-def
        run: |
          # Get the current task definition and save to file
          aws ecs describe-task-definition --task-definition url-shortener --query 'taskDefinition' --output json > current-task-def.json
          
          # Update the image in the task definition
          jq --arg IMAGE "${{ github.event.inputs.image-uri }}" '.containerDefinitions[0].image = $IMAGE' current-task-def.json > updated-task-def.json
          
          # Remove fields that shouldn't be in the new task definition
          jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy, .deregisteredAt)' updated-task-def.json > clean-task-def.json
          
          # Register the new task definition
          NEW_ARN=$(aws ecs register-task-definition --cli-input-json file://clean-task-def.json --query 'taskDefinition.taskDefinitionArn' --output text)
          
          echo "TASK_DEFINITION_ARN=$NEW_ARN" >> $GITHUB_OUTPUT
          echo "TASK_DEFINITION_REVISION=$(aws ecs describe-task-definition --task-definition $NEW_ARN --query 'taskDefinition.revision' --output text)" >> $GITHUB_OUTPUT

      - name: Update appspec.yml with new task definition
        run: |
          # Update appspec.yml with the new task definition ARN
          jq --arg TASK_DEF_ARN "${{ steps.create-task-def.outputs.TASK_DEFINITION_ARN }}" \
            '.Resources[0].TargetService.Properties.TaskDefinition = $TASK_DEF_ARN' \
            revisions/appspec.yml > updated-appspec.yml
          mv updated-appspec.yml revisions/appspec.yml
          
          echo "Updated appspec.yml with task definition: ${{ steps.create-task-def.outputs.TASK_DEFINITION_ARN }}"

      - name: Upload appspec.yml to S3
        run: |
          # Upload updated appspec.yml to S3 bucket
          aws s3 cp revisions/appspec.yml s3://url-shortener-codedeploy-revisions/appspec.yml
          echo "Uploaded appspec.yml to S3"

      - name: Create CodeDeploy deployment
        id: deployment
        run: |
          # Create a new deployment
          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name url-shortener-codedeploy-app \
            --deployment-group-name url-shortener-dg \
            --s3-location bucket=url-shortener-codedeploy-revisions,key=appspec.yml,bundleType=YAML \
            --region eu-west-2 \
            --query 'deploymentId' \
            --output text)
          
          echo "Deployment ID: $DEPLOYMENT_ID"
          echo "deployment-id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT

      - name: Wait for deployment completion
        run: |
          DEPLOYMENT_ID="${{ steps.deployment.outputs.deployment-id }}"
          echo "Waiting for deployment $DEPLOYMENT_ID to complete..."
          
          # Wait for deployment to complete (with timeout)
          aws deploy wait deployment-successful --deployment-id $DEPLOYMENT_ID --region eu-west-2
          
          if [ $? -eq 0 ]; then
            echo " Deployment successful!"
          else
            echo "Deployment failed!"
            exit 1
          fi

      - name: Output deployment results
        run: |
          echo "Deployment completed successfully!"
          echo "Image: ${{ github.event.inputs.image-uri }}"
          echo "Task Definition: ${{ steps.create-task-def.outputs.TASK_DEFINITION_ARN }}"
          echo "Deployment ID: ${{ steps.deployment.outputs.deployment-id }}"
          echo ""
          echo "Your application is now running with the new version!"
